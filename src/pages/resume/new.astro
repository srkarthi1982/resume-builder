---
import AppShell from "../../layouts/AppShell.astro";
import {
  AvButton,
  AvCard,
  AvContainer,
  AvInput,
  AvBreadcrumb,
  AvTextarea,
  AvDrawer,
} from "@ansiversa/components";

const templateId = Astro.url.searchParams.get("template") ?? "";
---
<AppShell title="New resume" description="Start a new resume draft.">
  <section
    class="av-page av-page--content av-resume-editor"
    x-data="{ drawerOpen: false }"
    x-init="
      $store.resumeBuilder.isLoading = true;
      (async () => {
        await $store.resumeBuilder.initEditorForNew($el.dataset.templateId || null);
        $store.resumeBuilder.isLoading = false;
      })();
    "
    data-template-id={templateId}
  >
    <div x-show="$store.resumeBuilder.isLoading" class="av-loading-bar"></div>
    <AvContainer>
      <AvBreadcrumb
          items={[
            { label: "Apps", href: "https://ansiversa.com/apps" }, 
            { label: "Resumes", href: "/resumes" },
            { label: "New" },
          ]}
        />
      <header class="av-editor-header">
        <div class="av-editor-header__title">
          <h1 class="av-page-title">Resume preview</h1>
          <p class="av-page-subtitle">Update your details in the drawer and save to refresh this preview.</p>
        </div>
        <div class="av-editor-header__actions">
          <span class="av-status-pill" x-text="$store.resumeBuilder.editor.project.templateName"></span>
          <span class="av-save-indicator" x-text="$store.resumeBuilder.editor.isSaving ? 'Savingâ€¦' : 'Saved'"></span>
          <AvButton
            size="sm"
            variant="outline"
            x-on:click.prevent="$store.resumeBuilder.changeTemplate($store.resumeBuilder.activeTemplateId === 'clean' ? 'modern' : 'clean')"
          >
            Change template
          </AvButton>
          <AvButton size="sm" variant="primary" x-on:click="drawerOpen = true">
            Open editor
          </AvButton>
        </div>
      </header>

      <AvCard className="av-editor-panel av-preview-panel">
        <div class="av-panel-header">
          <div>
            <p class="av-panel-label">Preview</p>
            <h2 class="av-panel-title">Resume preview</h2>
          </div>
          <div class="av-panel-actions">
            <AvButton size="sm" variant="ghost" x-on:click.prevent="$store.resumeBuilder.refreshPreview()">Refresh</AvButton>
            <AvButton size="sm" variant="ghost">Export PDF</AvButton>
          </div>
        </div>

        <div class="av-preview">
          <h3 class="av-preview__title" x-text="$store.resumeBuilder.editor.project.title"></h3>
          <p class="av-preview__subtitle" x-text="$store.resumeBuilder.editor.project.targetRole"></p>
          <div class="av-preview__meta">
            <span x-text="$store.resumeBuilder.editor.project.location"></span>
          </div>
          <div class="av-preview__summary" x-html="$store.resumeBuilder.editor.previewHtml || 'Preview will appear after saving.'"></div>
          <div class="av-preview__sections">
            <template x-for="section in $store.resumeBuilder.editor.sections" :key="section.id">
              <div class="av-preview__section">
                <p class="av-preview__section-title" x-text="section.label"></p>
                <p class="av-preview__section-type" x-text="section.type"></p>
              </div>
            </template>
          </div>
        </div>
      </AvCard>
    </AvContainer>

    <template x-if="drawerOpen">
      <div x-on:close-drawer="drawerOpen = false">
        <AvDrawer
          title="Edit resume"
          description="Update your details and save to refresh the preview."
        >
          <div class="av-form-stack">
            <AvInput
              name="resumeTitle"
              label="Resume title"
              placeholder="e.g. Senior Frontend Developer"
              x-model="$store.resumeBuilder.editor.project.title"
              x-on:input="$store.resumeBuilder.editor.isDirty = true"
            />
            <AvInput
              label="Full name"
              name="fullName"
              placeholder="Your name"
              x-model="$store.resumeBuilder.editor.project.fullName"
              x-on:input="$store.resumeBuilder.updateField('profile', 'fullName', $event.target.value)"
            />
            <AvInput
              label="Headline"
              name="headline"
              placeholder="Role or focus"
              x-model="$store.resumeBuilder.editor.project.targetRole"
              x-on:input="$store.resumeBuilder.updateField('profile', 'targetRole', $event.target.value)"
            />
            <AvTextarea
              label="Summary"
              name="summary"
              rows={4}
              placeholder="Brief overview"
              x-model="$store.resumeBuilder.editor.project.summary"
              x-on:input="$store.resumeBuilder.updateField('profile', 'summary', $event.target.value)"
            />
            <AvInput
              label="Email"
              name="email"
              placeholder="you@example.com"
              x-model="$store.resumeBuilder.editor.project.email"
              x-on:input="$store.resumeBuilder.updateField('profile', 'email', $event.target.value)"
            />
            <AvInput
              label="Phone"
              name="phone"
              placeholder="+971-50-000-0000"
              x-model="$store.resumeBuilder.editor.project.phone"
              x-on:input="$store.resumeBuilder.updateField('profile', 'phone', $event.target.value)"
            />
            <AvInput
              label="Location"
              name="location"
              placeholder="Abu Dhabi, UAE"
              x-model="$store.resumeBuilder.editor.project.location"
              x-on:input="$store.resumeBuilder.updateField('profile', 'location', $event.target.value)"
            />
          </div>

          <div slot="footer" class="av-panel-actions">
            <AvButton variant="ghost" x-on:click="drawerOpen = false">Cancel</AvButton>
            <AvButton
              variant="primary"
              x-on:click.prevent="$store.resumeBuilder.saveEditor(); drawerOpen = false;"
            >
              Save changes
            </AvButton>
          </div>
        </AvDrawer>
      </div>
    </template>
  </section>

  <style>
    .av-loading-bar {
      height: 4px;
      width: 100%;
      background: linear-gradient(90deg, #22d3ee, #6366f1);
      animation: shimmer 1.6s linear infinite;
      margin-bottom: 1rem;
    }

    .av-breadcrumb__list {
      justify-content: flex-start;
    }

    @keyframes shimmer {
      0% {
        background-position: 0 0;
      }
      100% {
        background-position: 200% 0;
      }
    }

    .av-editor-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1.25rem;
      margin-bottom: 1.75rem;
      flex-wrap: wrap;
    }

    .av-editor-header__title {
      flex: 1 1 420px;
      min-width: 280px;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .av-editor-breadcrumb {
      color: var(--av-fg-muted, #94a3b8);
      margin-bottom: 0.35rem;
    }

    .av-page-title {
      font-size: 1.35rem;
      font-weight: 700;
    }

    .av-page-subtitle {
      color: var(--av-fg-muted, #94a3b8);
      max-width: 640px;
      line-height: 1.45;
    }

    .av-editor-header__actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .av-save-indicator {
      font-size: 0.9rem;
      color: var(--av-fg-muted, #94a3b8);
    }

    .av-editor-panel {
      height: 100%;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .av-preview-panel {
      min-height: 100%;
    }

    .av-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .av-panel-label {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--av-fg-muted, #94a3b8);
      margin-bottom: 0.25rem;
    }

    .av-panel-title {
      font-weight: 600;
    }

    .av-form-stack {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .av-panel-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .av-save-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--av-fg-muted, #94a3b8);
    }

    .av-status-pill {
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      background: rgba(45, 212, 191, 0.12);
      color: #5eead4;
      font-size: 0.85rem;
    }

    .av-pill {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      background: rgba(34, 211, 238, 0.12);
      color: #67e8f9;
      font-size: 0.85rem;
    }

    .av-preview {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding-top: 0.25rem;
    }

    .av-preview__title {
      font-size: 1.1rem;
      font-weight: 700;
    }

    .av-preview__subtitle {
      color: var(--av-fg-muted, #94a3b8);
    }

    .av-preview__meta {
      font-size: 0.9rem;
      color: var(--av-fg-soft, #cbd5e1);
    }

    .av-preview__summary {
      font-size: 0.95rem;
      color: var(--av-fg, #e2e8f0);
    }

    .av-preview__sections {
      display: grid;
      gap: 0.5rem;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    }

    .av-preview__section {
      padding: 0.65rem;
      border: 1px dashed rgba(148, 163, 184, 0.4);
      border-radius: 0.75rem;
    }

    .av-preview__section-title {
      font-weight: 600;
    }

    .av-preview__section-type {
      color: var(--av-fg-muted, #94a3b8);
      font-size: 0.85rem;
    }
  </style>
</AppShell>

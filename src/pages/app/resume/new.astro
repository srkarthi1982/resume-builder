---
import { Fragment } from "astro/jsx-runtime";
import { actions } from "astro:actions";
import AppShell from "../../../layouts/AppShell.astro";
import AvBreadcrumb from "../../../components/common/AvBreadcrumb.astro";
import AvPageHeader from "../../../components/common/AvPageHeader.astro";
import AvToolbar from "../../../components/common/AvToolbar.astro";
import AvResumeEditorShell from "../../../components/resume/AvResumeEditorShell.astro";
import AvResumeSectionList from "../../../components/resume/AvResumeSectionList.astro";
import AvResumeSectionFormShell from "../../../components/resume/AvResumeSectionFormShell.astro";
import AvTextarea from "../../../components/common/AvTextarea.astro";
import { AvButton, AvCard, AvContainer, AvInput } from "@ansiversa/components";

export const prerender = false;

const createResult = Astro.getActionResult(actions.createResume);
const savedAt = createResult?.data?.savedAt ?? "Not saved yet";
const saveStatus = createResult?.data ? "saved" : "idle";

const sections = [
  { id: "summary", type: "summary", title: "Summary", isVisible: true, isActive: true },
  { id: "experience", type: "experience", title: "Work Experience", isVisible: true, isActive: false },
  { id: "education", type: "education", title: "Education", isVisible: true, isActive: false },
  { id: "skills", type: "skills", title: "Skills", isVisible: true, isActive: false },
];
---

<AppShell>
  <AvBreadcrumb
    items={[
      { label: "Home", href: "/" },
      { label: "Resumes", href: "/app/resumes" },
      { label: "New Resume" },
    ]}
  />

  <AvPageHeader
    title="Create a New Resume"
    description="Start with a template and fill in your story step by step."
  />

  <AvToolbar
    saveStatus={saveStatus}
    lastSavedAt={savedAt}
    actions={[
      { label: "Change Template", href: "/templates" },
      { label: "Download PDF", href: "/app/resume/sample/pdf" },
    ]}
  />

  <AvContainer>
    <AvResumeEditorShell>
      <Fragment slot="sidebar">
        <AvResumeSectionList sections={sections} />

        <form class="av-resume-form" method="post" action={actions.createResume}>
          <input type="hidden" name="userId" value="demo-user" />

          <AvResumeSectionFormShell
            title="Resume basics"
            description="Save your starting point so you can keep editing later."
          >
            <AvInput
              label="Resume title"
              name="title"
              placeholder="Product Manager Resume"
              required
            />
            <AvInput label="Target role" name="targetRole" placeholder="e.g., Senior Product Manager" />
            <AvInput label="Target industry" name="targetIndustry" placeholder="e.g., Fintech" />
            <AvInput label="Location" name="location" placeholder="Dubai, UAE" />

            <label class="av-resume-form__label" for="templateKey">Template</label>
            <select id="templateKey" name="templateKey" class="av-resume-form__select" required>
              <option value="modern-blue">Modern Blue</option>
              <option value="minimal-white">Minimal White</option>
              <option value="two-column-professional">Two Column Professional</option>
              <option value="creative-accent">Creative Accent</option>
              <option value="executive-serif">Executive Serif</option>
              <option value="clean-monoline">Clean Monoline</option>
            </select>

            <AvTextarea
              label="Summary"
              name="summary"
              placeholder="Write a concise summary that highlights your strengths."
            />

            <div slot="actions" class="av-resume-form__actions">
              <AvButton type="submit" size="sm" variant="primary">
                Save resume
              </AvButton>
              {createResult?.data && (
                <p class="av-resume-form__status" role="status">
                  Resume saved with ID {createResult.data.resume.id}.
                </p>
              )}
              {createResult?.error && (
                <p class="av-resume-form__status" role="status" data-variant="error">
                  Unable to save resume. Please check your details and try again.
                </p>
              )}
            </div>
          </AvResumeSectionFormShell>
        </form>

        <AvResumeSectionFormShell
          title="Skills"
          description="List tools, frameworks, and strengths relevant to the target role."
        >
          <AvInput label="Skill" placeholder="e.g., Product discovery" />
          <AvInput label="Category" placeholder="e.g., Product management" />
        </AvResumeSectionFormShell>
      </Fragment>

      <Fragment slot="preview">
        <AvCard className="av-resume-preview">
          <div class="av-resume-preview__header">
            <h2 class="av-resume-preview__name">Amina Rahman</h2>
            <p class="av-resume-preview__role">Product Manager</p>
            <p class="av-resume-preview__meta">Dubai, UAE • amina@example.com • +971 555 1234</p>
          </div>
          <div class="av-resume-preview__section">
            <h3 class="av-resume-preview__section-title">Summary</h3>
            <p class="av-resume-preview__text">
              Product manager focused on building reliable fintech experiences with strong stakeholder alignment and measurable
              impact across growth and retention.
            </p>
          </div>
          <div class="av-resume-preview__section">
            <h3 class="av-resume-preview__section-title">Work Experience</h3>
            <div class="av-resume-preview__item">
              <p class="av-resume-preview__item-title">Senior Product Manager — Fintech Corp</p>
              <p class="av-resume-preview__item-meta">Jan 2020 – Present · Dubai, UAE</p>
              <ul class="av-resume-preview__list">
                <li>Led rollout of payment features that reduced checkout drop-off by 14%.</li>
                <li>Partnered with compliance to streamline KYC flows for enterprise clients.</li>
              </ul>
            </div>
            <div class="av-resume-preview__item">
              <p class="av-resume-preview__item-title">Product Manager — StartUp Labs</p>
              <p class="av-resume-preview__item-meta">Jun 2017 – Dec 2019 · Chennai, India</p>
              <ul class="av-resume-preview__list">
                <li>Built experimentation program improving activation by 9%.</li>
                <li>Coordinated design system refresh for mobile app portfolio.</li>
              </ul>
            </div>
          </div>
        </AvCard>
      </Fragment>
    </AvResumeEditorShell>
  </AvContainer>
</AppShell>

<style>
  .av-resume-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .av-resume-form__label {
    font-weight: 600;
    color: rgb(30, 41, 59);
  }

  .av-resume-form__select {
    width: 100%;
    padding: 0.75rem 0.85rem;
    border-radius: 0.75rem;
    border: 1px solid rgb(226, 232, 240);
    background: #fff;
    font-size: 1rem;
  }

  .av-resume-form__actions {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .av-resume-form__status {
    font-size: 0.95rem;
    color: rgb(21, 128, 61);
    margin: 0;
  }

  .av-resume-form__status[data-variant="error"] {
    color: rgb(220, 38, 38);
  }
</style>

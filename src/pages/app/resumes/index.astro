---
import { actions } from "astro:actions";
import AppShell from "../../../layouts/AppShell.astro";
import AvBreadcrumb from "../../../components/common/AvBreadcrumb.astro";
import AvPageHeader from "../../../components/common/AvPageHeader.astro";
import AvEmptyState from "../../../components/common/AvEmptyState.astro";
import AvResumeCard from "../../../components/resume/AvResumeCard.astro";
import { AvButton, AvContainer } from "@ansiversa/components";

export const prerender = false;

const userId = "demo-user";
const listResult = await actions.listResumes({ userId });
const resumes = listResult.data?.resumes ?? [];
const loadError = listResult.error;
const deleteResult = Astro.getActionResult(actions.deleteResume);

const formatUpdatedAt = (value?: string | null) => {
  if (!value) return "Not updated yet";
  const date = new Date(value);
  if (Number.isNaN(date.getTime())) return value;
  return `Updated ${date.toLocaleDateString(undefined, { month: "short", day: "numeric" })}`;
};
---

<AppShell>
  <AvBreadcrumb
    items={[
      { label: "Home", href: "/" },
      { label: "Resumes" },
    ]}
  />

  <AvPageHeader
    title="Your Resumes"
    description="Create and manage tailored resumes for different roles."
    primaryAction={{
      label: "Create New Resume",
      href: "/app/resume/new",
      variant: "primary",
    }}
  />

  <section class="av-section">
    <AvContainer>
      {loadError ? (
        <p class="av-resume-alert" role="alert" data-variant="error">
          Unable to load your resumes right now. Please refresh and try again.
        </p>
      ) : null}
      {deleteResult?.data ? (
        <p class="av-resume-alert" role="status">
          Resume {deleteResult.data.deletedId} deleted.
        </p>
      ) : null}
      {deleteResult?.error ? (
        <p class="av-resume-alert" role="alert" data-variant="error">
          Unable to delete resume. Please try again.
        </p>
      ) : null}

      {resumes.length > 0 ? (
        <div class="av-section__grid">
          {resumes.map((resume) => (
            <AvResumeCard
              id={resume.id}
              title={resume.title}
              targetRole={resume.target_role ?? ""}
              location={resume.location ?? ""}
              updatedAt={formatUpdatedAt(resume.updated_at)}
              editHref={`/app/resume/${resume.id}`}
              downloadHref={`/app/resume/${resume.id}/pdf`}
            >
              <form slot="actions" method="post" action={actions.deleteResume} class="av-resume-card__form">
                <input type="hidden" name="id" value={resume.id} />
                <AvButton type="submit" variant="ghost" size="sm">Delete</AvButton>
              </form>
            </AvResumeCard>
          ))}
        </div>
      ) : (
        <AvEmptyState
          title="No resumes yet"
          description="Start with a template and craft your story."
          ctaLabel="Create Your First Resume"
          ctaHref="/app/resume/new"
        />
      )}
    </AvContainer>
  </section>
</AppShell>

<style>
  .av-resume-card__form {
    display: inline-flex;
  }

  .av-resume-alert {
    margin: 0 0 1rem;
    padding: 0.75rem 1rem;
    border-radius: 0.75rem;
    background: #f0f9ff;
    color: #0f172a;
  }

  .av-resume-alert[data-variant="error"] {
    background: #fef2f2;
    color: #b91c1c;
  }
</style>

---
import {
  AvBookmarkButton,
  AvButton,
  AvCard,
  AvConfirmDialog,
  AvContainer,
  AvEmptyState,
  AvIcon,
  AvInput,
} from "@ansiversa/components";
import { actions } from "astro:actions";
import ResumeEditorDrawer from "../../../components/ResumeEditorDrawer.astro";
import AppShell from "../../../layouts/AppShell.astro";
import { RESUME_MAX } from "../../../modules/resume-builder/constraints";
import { TEMPLATE_OPTIONS } from "../../../modules/resume-builder/helpers";
import type { ResumeProjectDTO } from "../../../modules/resume-builder/types";

const title = "Your Resumes â€“ Resume Builder";
const description = "Create and manage your resumes.";
const isPaid = Astro.locals.user?.isPaid === true;

const listResult = await Astro.callAction(actions.resumeBuilder.listResumeProjects, {});
const data = (listResult as any)?.data ?? (listResult as any) ?? {};
const projects = (data?.items ?? []) as ResumeProjectDTO[];
const bookmarkResult = await Astro.callAction(actions.resumeBuilder.listResumeBookmarks, {});
const bookmarkData = (bookmarkResult as any)?.data ?? (bookmarkResult as any) ?? {};
const bookmarkedResumeIds = Array.isArray(bookmarkData?.items)
  ? bookmarkData.items.map((item: any) => String(item.resumeId))
  : [];

const initialState = {
  projects,
  isPaid,
  paywallMessage: null,
  templateOptions: TEMPLATE_OPTIONS,
  newProject: {
    title: "",
    templateKey: "classic",
  },
  pendingDeleteId: null,
  pendingDeleteName: null,
  bookmarkedResumeIds,
};
---

<AppShell title={title} description={description}>
  <section class="av-section">
    <AvContainer>
      <div
        class="av-auth-stack-lg"
        x-data="$store.resumeBuilder"
        x-init="init && init(JSON.parse($el.dataset.initial))"
        data-initial={JSON.stringify(initialState)}
      >
        <AvCard className="av-auth-card">
          <div class="av-auth-stack-md">
            <div class="av-row-between">
              <div class="av-auth-stack-xs">
                <p class="av-kicker">Resume Builder</p>
                <h1 class="av-section-title">Your resumes</h1>
                <p class="av-text-soft">Create a new resume or continue editing an existing one.</p>
              </div>
              <div class="av-row-wrap">
                <AvButton type="button" @click.prevent="openCreateDrawer()">Create resume</AvButton>
              </div>
            </div>

            <template x-if="error">
              <div class="av-alert av-alert-danger" role="status" x-text="error"></div>
            </template>
            <template x-if="success">
              <div class="av-alert av-alert-success" role="status" x-text="success"></div>
            </template>
          </div>
        </AvCard>

        <template x-if="createDrawerOpen">
          <div
            class="av-drawer-overlay"
            @click="closeCreateDrawer()"
            @keydown.escape.window="closeCreateDrawer()"
            @close-drawer="closeCreateDrawer()"
            x-cloak
          >
            <div class="rb-drawer-panel" @click.stop @mousedown.stop @pointerdown.stop>
              <ResumeEditorDrawer
                titleExpr="'Create resume'"
                descriptionExpr="'Enter details and save to start editing.'"
              >
                <form id="create-resume-form" class="av-auth-stack-sm" @submit.prevent="createProject()">
                  <AvInput
                    label="Resume title"
                    name="resume-title"
                    placeholder="e.g. Product Designer Resume"
                    x-model="newProject.title"
                    maxlength={RESUME_MAX.projectTitle}
                    required
                  />
                  <p class="av-form-hint" x-text="`${(newProject.title || '').length} / ${RESUME_MAX.projectTitle}`"></p>

                  <div class="av-resume-template-grid">
                    <template x-for="template in templateOptions" :key="template.key">
                      <button
                        class="av-resume-template-card"
                        :class="newProject.templateKey === template.key ? 'is-selected' : ''"
                        type="button"
                        @click.prevent="selectNewTemplate(template.key)"
                        :disabled="isTemplateLocked(template.key)"
                      >
                        <div class="av-row-between">
                          <p class="av-card-heading" x-text="template.label"></p>
                          <span class="av-badge av-badge-soft" x-show="template.tier === 'pro' && !isPaid" x-cloak>Pro</span>
                        </div>
                        <p class="av-text-soft" x-text="template.tier === 'pro' ? 'Included in Pro' : 'Free access'"></p>
                      </button>
                    </template>
                  </div>
                </form>

                <Fragment slot="footer">
                  <div class="av-auth-stack-xs av-w-full">
                    <template x-if="createError">
                      <div class="av-alert av-alert-danger" role="status" x-text="createError"></div>
                    </template>
                    <template x-if="paywallMessage">
                      <div class="av-alert av-alert-warning" role="status" x-text="paywallMessage"></div>
                    </template>
                    <div class="av-row-wrap rb-drawer-footer-actions">
                      <AvButton variant="ghost" type="button" @click="closeCreateDrawer()">Close</AvButton>
                      <AvButton type="submit" form="create-resume-form" :disabled="loading">Save</AvButton>
                    </div>
                  </div>
                </Fragment>
              </ResumeEditorDrawer>
            </div>
          </div>
        </template>

        <AvCard variant="soft" className="av-auth-stack-md">
          <div class="av-row-between">
            <h2 class="av-card-heading">Resume list</h2>
            <p class="av-text-soft" x-text="projects.length + ' total'"></p>
          </div>

          <template x-if="projects.length === 0">
            <AvEmptyState
              headline="No resumes yet"
              description="Create your first resume to start editing."
            />
          </template>

          <template x-if="projects.length > 0">
            <div class="av-resume-list-grid">
              <template x-for="project in projects" :key="project.id">
                <AvCard variant="soft" className="av-card--fullheight">
                  <div class="av-auth-stack-sm">
                    <div class="av-auth-stack-xxs">
                      <div class="av-row-between rb-resume-card-title-row">
                        <h3 class="av-card-heading rb-resume-card-title" x-text="project.title"></h3>
                        <template x-if="project.isDefault">
                          <span class="av-badge av-badge-soft rb-default-badge">Default</span>
                        </template>
                      </div>
                      <p class="av-text-soft" x-text="`Template: ${project.templateKey}`"></p>
                    </div>

                    <div class="rb-experience-actions">
                      <AvButton
                        variant="ghost"
                        size="sm"
                        href="#"
                        x-bind:href="`/app/resumes/${project.id}`"
                        className="rb-experience-action-btn"
                        title="Edit resume"
                        aria-label="Edit resume"
                      >
                        <AvIcon name="edit" size="sm" />
                      </AvButton>
                      <AvButton
                        variant="ghost"
                        size="sm"
                        href="#"
                        x-bind:href="`/app/resumes/${project.id}/print`"
                        target="_blank"
                        rel="noopener noreferrer"
                        className="rb-experience-action-btn"
                        title="Preview or print resume"
                        aria-label="Preview or print resume"
                      >
                        <AvIcon name="eye" size="sm" />
                      </AvButton>
                      <AvButton
                        variant="ghost"
                        size="sm"
                        type="button"
                        @click.prevent="setDefault(project.id)"
                        :disabled="project.isDefault || loading"
                        className="rb-experience-action-btn"
                        :title="project.isDefault ? 'Already default resume' : 'Set as default resume'"
                        :aria-label="project.isDefault ? 'Already default resume' : 'Set as default resume'"
                      >
                        <span class="rb-default-icon" aria-hidden="true">
                          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="9"></circle>
                            <path d="M8.5 12.5l2.2 2.2 4.8-4.8"></path>
                          </svg>
                        </span>
                      </AvButton>
                      <AvBookmarkButton
                        active={false}
                        activeExpr="isResumeBookmarked(project.id)"
                        title="Save bookmark"
                        activeTitle="Remove bookmark"
                        onClick="toggleResumeBookmark(project.id, project.title)"
                        size="sm"
                      />
                      <AvButton
                        variant="ghost"
                        size="sm"
                        type="button"
                        @click.prevent="pendingDeleteId = project.id; pendingDeleteName = project.title || null; const dialogTitle = document.getElementById('resume-delete-dialog-title'); if (dialogTitle) dialogTitle.textContent = pendingDeleteName ? `Delete resume '${pendingDeleteName}'?` : 'Delete this item?'; window.AvDialog?.open('resume-delete-dialog')"
                        :disabled="loading"
                        className="rb-experience-action-btn"
                        title="Delete resume"
                        aria-label="Delete resume"
                      >
                        <AvIcon name="trash" size="sm" />
                      </AvButton>
                    </div>
                  </div>
                </AvCard>
              </template>
            </div>
          </template>
        </AvCard>

        <AvConfirmDialog
          id="resume-delete-dialog"
          headline="Delete this item?"
          description="This action cannot be undone."
          confirmLabel="Delete"
          cancelLabel="Cancel"
          variant="danger"
          @av-confirm="pendingDeleteId && deleteProject(pendingDeleteId)"
          @av-cancel="pendingDeleteId = null; pendingDeleteName = null"
        />
      </div>
    </AvContainer>
  </section>
</AppShell>

---
import {
  AvAiAssist,
  AvButton,
  AvCard,
  AvContainer,
  AvEmptyState,
  AvIcon,
  AvImageUploader,
  AvInput,
  AvLoading,
  AvSelect,
  AvTextarea,
} from "@ansiversa/components";
import { actions } from "astro:actions";
import AppShell from "../../../layouts/AppShell.astro";
import ResumeEditorDrawer from "../../../components/ResumeEditorDrawer.astro";
import { RESUME_MAX, RESUME_MONTH_OPTIONS, getResumeYearOptions } from "../../../modules/resume-builder/constraints";
import type { ResumeProjectDetail } from "../../../modules/resume-builder/types";
import { TEMPLATE_OPTIONS, sectionLabels } from "../../../modules/resume-builder/helpers";

const projectId = Astro.params.id ?? "";
const isPaid = Astro.locals.user?.isPaid === true;

let projectData: ResumeProjectDetail | null = null;
let loadError: string | null = null;
let isPaywall = false;

try {
  const result = await Astro.callAction(actions.resumeBuilder.getResumeProject, {
    projectId,
  });
  const data = (result as any)?.data ?? (result as any) ?? null;
  projectData = data as ResumeProjectDetail;
} catch (err) {
  loadError = (err as Error)?.message ?? "Unable to load resume.";
  isPaywall = loadError.toLowerCase().includes("upgrade to pro");
}

const title = projectData?.project?.title
  ? `Edit ${projectData.project.title} – Resume Builder`
  : "Edit Resume – Resume Builder";
const description = "Edit your resume and preview the chosen template.";

const initialState = {
  activeProject: projectData,
  activeProjectId: projectData?.project?.id ?? projectId,
  projects: [],
  isPaid,
  rootAppUrl: Astro.locals.rootAppUrl ?? null,
  paywallMessage: null,
  templateOptions: TEMPLATE_OPTIONS,
};

const sectionOrder = [
  "photo",
  "basics",
  "summary",
  "experience",
  "education",
  "skills",
  "projects",
  "certifications",
  "awards",
  "languages",
  "highlights",
  "declaration",
] as const;

const yearOptions = getResumeYearOptions();
const monthOptions = RESUME_MONTH_OPTIONS;
const mediaUploadUrl = "/api/media/upload.json";
---

<AppShell title={title} description={description}>
  <section class="av-section">
    <AvContainer>
      <div
        class="av-resume-editor-layout"
        x-data="$store.resumeBuilder"
        x-init="init && init(JSON.parse($el.dataset.initial))"
        @av:resume-project-photo-uploaded.window="saveProjectPhoto($event.detail)"
        data-initial={JSON.stringify(initialState)}
      >
        {loadError ? (
          <AvCard variant="soft" className="av-auth-stack-sm lg:col-span-2">
            <AvEmptyState headline="Unable to load resume" description={loadError} />
            <div class="av-row-wrap">
              <AvButton href="/app/resumes" variant="ghost">Back to resumes</AvButton>
              {isPaywall ? (
                <AvButton href="https://ansiversa.com/pricing" variant="primary">View pricing</AvButton>
              ) : null}
            </div>
          </AvCard>
        ) : (
          <>
            <div class="av-resume-editor-column">
              <AvCard variant="soft" className="av-auth-stack-md">
                <div class="av-auth-stack-xs">
                  <p class="av-kicker">Resume Builder</p>
                  <h1 class="av-section-title">Edit resume</h1>
                  <p class="av-text-soft">
                    Update your resume content and refresh the preview whenever you save changes.
                  </p>
                </div>

                <form class="av-auth-stack-sm" @submit.prevent="saveProjectMeta()">
                  <AvInput
                    label="Resume title"
                    name="resume-title"
                    placeholder="Resume name"
                    x-model="projectMeta.title"
                    maxlength={RESUME_MAX.projectTitle}
                    required
                  />
                  <p class="av-form-hint" x-text={`(projectMeta.title || '').length + ' / ${RESUME_MAX.projectTitle}'`}></p>

                  <div class="av-resume-template-grid">
                    <template x-for="template in templateOptions" :key="template.key">
                      <button
                        class="av-resume-template-card"
                        :class="projectMeta.templateKey === template.key ? 'is-selected' : ''"
                        type="button"
                        @click.prevent="selectProjectTemplate(template.key)"
                        :disabled="isTemplateLocked(template.key)"
                      >
                        <div class="av-row-between">
                          <p class="av-card-heading" x-text="template.label"></p>
                          <span class="av-badge av-badge-soft" x-show="template.tier === 'pro' && !isPaid" x-cloak>Pro</span>
                        </div>
                        <p class="av-text-soft" x-text="template.tier === 'pro' ? 'Included in Pro' : 'Free access'"></p>
                      </button>
                    </template>
                  </div>

                  <div class="av-row-wrap" x-show="paywallMessage" x-cloak>
                    <p class="av-text-soft av-m-0" x-text="paywallMessage"></p>
                    <AvButton href="https://ansiversa.com/pricing" variant="ghost" size="sm">
                      View pricing
                    </AvButton>
                  </div>

                  <div class="av-row-wrap">
                    <AvButton type="submit" :disabled="loading">Save details</AvButton>
                    <AvButton href={`/app/resumes/${projectId}/print`} variant="ghost" target="_blank">
                      Preview / Print
                    </AvButton>
                  </div>
                </form>

                <template x-if="error && !drawerOpen">
                  <div class="av-alert av-alert-danger" role="status" x-text="error"></div>
                </template>
                <template x-if="warning && !drawerOpen">
                  <div class="av-alert av-alert-warning" role="status" x-text="warning"></div>
                </template>
                <template x-if="success">
                  <div class="av-alert av-alert-success" role="status" x-text="success"></div>
                </template>
              </AvCard>

              <AvCard variant="soft" className="av-auth-stack-sm">
                <div class="av-row-between">
                  <h2 class="av-card-heading">Sections</h2>
                  <p class="av-text-soft">Edit each section</p>
                </div>

                <div class="av-resume-sections-grid">
                  {sectionOrder.map((key) => (
                    <button
                      class="av-resume-section-chip"
                      type="button"
                      @click.prevent={`openSection('${key}')`}
                    >
                      <span>{key === "photo" ? "Photo" : sectionLabels[key]}</span>
                      <span class="av-resume-section-chip-icon">
                        <AvIcon name="chevron-right" size="sm" />
                      </span>
                    </button>
                  ))}
                </div>
              </AvCard>
            </div>

            <div class="av-resume-editor-column">
              <AvCard variant="soft" className="av-auth-stack-sm">
                <div class="av-row-between">
                  <h2 class="av-card-heading">Live preview</h2>
                  <p class="av-text-soft">Saved changes appear here</p>
                </div>
                <iframe
                  class="av-resume-preview-frame"
                  title="Resume preview"
                  x-bind:src="previewSrc"
                ></iframe>
              </AvCard>
            </div>
          </>
        )}

        <AvLoading x-show="loading" x-cloak label="Saving…" />

        <template x-if="drawerOpen">
          <div
            class="av-drawer-overlay"
            @click="closeDrawer()"
            @keydown.escape.window="closeDrawer()"
            @close-drawer="closeDrawer()"
            x-cloak
          >
            <div class="rb-drawer-panel" @click.stop @mousedown.stop @pointerdown.stop>
              <ResumeEditorDrawer
                titleExpr="getSectionLabel(activeSectionKey)"
                descriptionExpr="activeSectionKey === 'photo' ? 'Uploading updates instantly.' : 'Save to refresh the preview.'"
              >
                <div class="av-auth-stack-md">
                  <template x-if="activeSectionKey === 'basics'">
                    <form class="av-auth-stack-sm" @submit.prevent="saveActiveItem()">
                      <AvInput label="Full name" name="full-name" x-model="formData.fullName" maxlength={RESUME_MAX.fullName} @input={`enforceLimit('fullName', ${RESUME_MAX.fullName})`} required />
                      <p class="av-form-hint" x-text={`(formData.fullName || '').length + ' / ${RESUME_MAX.fullName}'`}></p>

                    <AvInput label="Job title" name="headline" x-model="formData.headline" maxlength={RESUME_MAX.headline} @input={`enforceLimit('headline', ${RESUME_MAX.headline})`} />
                    <p class="av-form-hint" x-text={`(formData.headline || '').length + ' / ${RESUME_MAX.headline}'`}></p>

                    <div class="av-resume-field-grid-2">
                      <AvInput label="Email" type="email" name="email" x-model="formData.contact.email" maxlength={RESUME_MAX.email} @input={`enforceLimit('contact.email', ${RESUME_MAX.email})`} />
                      <AvInput label="Phone" type="tel" name="phone" x-model="formData.contact.phone" maxlength={RESUME_MAX.phone} @input={`enforceLimit('contact.phone', ${RESUME_MAX.phone})`} />
                    </div>

                    <AvInput label="Location" name="location-text" x-model="formData.locationText" maxlength={RESUME_MAX.locationLabel} @input={`enforceLimit('locationText', ${RESUME_MAX.locationLabel})`} />
                    <p class="av-form-hint" x-text={`(formData.locationText || '').length + ' / ${RESUME_MAX.locationLabel}'`}></p>

                    <div class="av-auth-stack-xs">
                      <div class="av-row-between">
                        <h3 class="av-card-heading">Links</h3>
                        <AvButton variant="ghost" type="button" @click.prevent="addLink()">
                          Add link
                        </AvButton>
                      </div>
                      <template x-for="(link, index) in formData.links" :key="index">
                        <div class="av-resume-field-grid-link">
                          <AvInput
                            label="Label"
                            name="link-label"
                            x-model="link.label"
                            maxlength={RESUME_MAX.linkLabel}
                            @input={`enforceLimit('links.' + index + '.label', ${RESUME_MAX.linkLabel})`}
                          />
                          <AvInput
                            label="URL"
                            type="url"
                            name="link-url"
                            x-model="link.url"
                            maxlength={RESUME_MAX.linkUrl}
                            @input={`enforceLimit('links.' + index + '.url', ${RESUME_MAX.linkUrl})`}
                          />
                          <AvButton
                            variant="ghost"
                            type="button"
                            title="Remove link"
                            @click.prevent="removeLink(index)"
                          >
                            <AvIcon name="trash" size="sm" />
                          </AvButton>
                        </div>
                      </template>
                    </div>
                  </form>
                </template>

                <div class="av-auth-stack-sm" x-show="activeSectionKey === 'photo'" x-cloak>
                  <AvImageUploader
                    uploadUrl={mediaUploadUrl}
                    scope="account"
                    purpose="avatar"
                    label="Profile photo"
                    helpText="JPG, PNG, or WebP up to 2 MB."
                    initialUrl={projectData?.project?.photoUrl ?? null}
                    onUploadedEventName="av:resume-project-photo-uploaded"
                  />
                  <p class="av-text-soft">
                    Uploading updates your resume photo instantly in preview and print.
                  </p>
                </div>

                <template x-if="activeSectionKey === 'summary'">
                  <form class="av-auth-stack-sm" @submit.prevent="saveActiveItem()">
                    <div class="av-row-between av-resume-ai-header">
                      <label class="av-label" for="summary-text">Summary</label>
                      <AvAiAssist
                        featureKey="resume.remark_suggestions"
                        value=""
                        minChars={30}
                        maxChars={1500}
                        label="AI"
                        valueSourceSelector="#summary-text"
                        onAppendEvent="av:ai-append"
                        onReplaceEvent="av:ai-replace"
                      />
                    </div>
                    <AvTextarea
                      id="summary-text"
                      name="summary"
                      rows={5}
                      x-model="formData.text"
                      maxlength={RESUME_MAX.summary}
                      @input={`enforceLimit('text', ${RESUME_MAX.summary})`}
                      placeholder="Write a short professional summary."
                    />
                    <p class="av-form-hint" x-text={`(formData.text || '').length + ' / ${RESUME_MAX.summary}'`}></p>
                  </form>
                </template>

                <template x-if="activeSectionKey === 'declaration'">
                  <form class="av-auth-stack-sm" @submit.prevent="saveActiveItem()">
                    <AvTextarea
                      label="Declaration"
                      name="declaration"
                      rows={4}
                      x-model="formData.text"
                      maxlength={RESUME_MAX.declaration}
                      @input={`enforceLimit('text', ${RESUME_MAX.declaration})`}
                      placeholder="I hereby declare that the information furnished above is true to the best of my knowledge."
                    />
                    <p class="av-form-hint" x-text={`(formData.text || '').length + ' / ${RESUME_MAX.declaration}'`}></p>
                    <div class="av-resume-field-grid-2">
                      <AvInput label="Place" name="declaration-place" x-model="formData.place" maxlength={RESUME_MAX.declarationPlace} @input={`enforceLimit('place', ${RESUME_MAX.declarationPlace})`} />
                      <AvInput label="Name" name="declaration-name" x-model="formData.name" maxlength={RESUME_MAX.declarationName} @input={`enforceLimit('name', ${RESUME_MAX.declarationName})`} />
                    </div>
                  </form>
                </template>

                <template x-if="activeSectionKey === 'experience'">
                  <div class="av-auth-stack-md">
                    <template x-if="activeSectionItems.length">
                      <div class="av-auth-stack-xs">
                        <template x-for="item in activeSectionItems" :key="item.id">
                          <div class="av-resume-item-row">
                            <div class="rb-experience-item-title" x-text="itemLabel(item)"></div>
                            <div class="rb-experience-actions">
                              <AvButton
                                variant="ghost"
                                size="sm"
                                type="button"
                                className="rb-experience-action-btn"
                                aria-label="Edit experience"
                                title="Edit experience"
                                @click.prevent="editItem(item)"
                              >
                                <AvIcon name="edit" size="sm" />
                              </AvButton>
                              <AvButton
                                variant="ghost"
                                size="sm"
                                type="button"
                                className="rb-experience-action-btn"
                                aria-label="Delete experience"
                                title="Delete experience"
                                @click.prevent="deleteItem(item.id)"
                              >
                                <AvIcon name="trash" size="sm" />
                              </AvButton>
                            </div>
                          </div>
                        </template>
                      </div>
                    </template>
                    <AvButton variant="ghost" size="sm" type="button" className="rb-experience-add-btn" @click.prevent="startNewItem()">
                      <AvIcon name="plus" size="sm" />
                      <span>Add experience</span>
                    </AvButton>

                    <form class="av-auth-stack-sm" @submit.prevent="saveActiveItem()">
                      <AvInput label="Role" name="role" x-model="formData.role" maxlength={RESUME_MAX.role} @input={`enforceLimit('role', ${RESUME_MAX.role})`} required />
                      <p class="av-form-hint" x-text={`(formData.role || '').length + ' / ${RESUME_MAX.role}'`}></p>

                      <AvInput label="Company" name="company" x-model="formData.company" maxlength={RESUME_MAX.company} @input={`enforceLimit('company', ${RESUME_MAX.company})`} required />
                      <p class="av-form-hint" x-text={`(formData.company || '').length + ' / ${RESUME_MAX.company}'`}></p>

                      <AvInput label="Location" name="location" x-model="formData.location" maxlength={RESUME_MAX.location} @input={`enforceLimit('location', ${RESUME_MAX.location})`} />

                      <div class="av-resume-field-grid-date">
                        <AvSelect label="Start year" name="start-year" x-model="formData.startYear">
                          <option value="">Select year</option>
                          {yearOptions.map((year) => <option value={year}>{year}</option>)}
                        </AvSelect>
                        <AvSelect label="Start month" name="start-month" x-model="formData.startMonth">
                          <option value="">Select month</option>
                          {monthOptions.map((month) => <option value={month.value}>{month.label}</option>)}
                        </AvSelect>
                        <AvSelect label="End year" name="end-year" x-model="formData.endYear" :disabled="formData.present">
                          <option value="">Select year</option>
                          {yearOptions.map((year) => <option value={year}>{year}</option>)}
                        </AvSelect>
                        <AvSelect label="End month" name="end-month" x-model="formData.endMonth" :disabled="formData.present">
                          <option value="">Select month</option>
                          {monthOptions.map((month) => <option value={month.value}>{month.label}</option>)}
                        </AvSelect>
                      </div>

                      <label class="av-inline-check av-text-soft">
                        <input class="av-checkbox" type="checkbox" x-model="formData.present" @change="togglePresent()" />
                        <span>Currently here</span>
                      </label>

                      <AvTextarea label="Summary" name="summary" rows={3} x-model="formData.summary" maxlength={RESUME_MAX.experienceSummary} @input={`enforceLimit('summary', ${RESUME_MAX.experienceSummary})`} />
                      <p class="av-form-hint" x-text={`(formData.summary || '').length + ' / ${RESUME_MAX.experienceSummary}'`}></p>

                      <AvTextarea label="Highlights (one per line)" name="bullets" rows={4} x-model="formData.bullets" maxlength={RESUME_MAX.bulletBlock} @input={`enforceLineLimit('bullets', ${RESUME_MAX.bulletLine})`} />
                      <p class="av-form-hint">Each bullet max {RESUME_MAX.bulletLine} characters.</p>

                      <AvInput label="Tags (comma separated)" name="tags" x-model="formData.tags" maxlength={RESUME_MAX.tagsLine} @input={`enforceLimit('tags', ${RESUME_MAX.tagsLine})`} />
                    </form>
                  </div>
                </template>

                <template x-if="activeSectionKey === 'education'">
                  <div class="av-auth-stack-md">
                    <template x-if="activeSectionItems.length">
                      <div class="av-auth-stack-xs">
                        <template x-for="item in activeSectionItems" :key="item.id">
                          <div class="av-resume-item-row">
                            <p class="av-text-strong" x-text="itemLabel(item)"></p>
                            <div class="rb-experience-actions">
                              <AvButton
                                variant="ghost"
                                size="sm"
                                type="button"
                                className="rb-experience-action-btn"
                                aria-label="Edit education"
                                title="Edit education"
                                @click.prevent="editItem(item)"
                              >
                                <AvIcon name="edit" size="sm" />
                              </AvButton>
                              <AvButton
                                variant="ghost"
                                size="sm"
                                type="button"
                                className="rb-experience-action-btn"
                                aria-label="Delete education"
                                title="Delete education"
                                @click.prevent="deleteItem(item.id)"
                              >
                                <AvIcon name="trash" size="sm" />
                              </AvButton>
                            </div>
                          </div>
                        </template>
                      </div>
                    </template>
                    <AvButton variant="ghost" size="sm" type="button" className="rb-experience-add-btn" @click.prevent="startNewItem()">
                      <AvIcon name="plus" size="sm" />
                      <span>Add education</span>
                    </AvButton>

                    <form class="av-auth-stack-sm" @submit.prevent="saveActiveItem()">
                      <AvInput label="Degree" name="degree" x-model="formData.degree" maxlength={RESUME_MAX.degree} @input={`enforceLimit('degree', ${RESUME_MAX.degree})`} required />
                      <p class="av-form-hint" x-text={`(formData.degree || '').length + ' / ${RESUME_MAX.degree}'`}></p>

                      <AvInput label="School" name="school" x-model="formData.school" maxlength={RESUME_MAX.school} @input={`enforceLimit('school', ${RESUME_MAX.school})`} required />
                      <p class="av-form-hint" x-text={`(formData.school || '').length + ' / ${RESUME_MAX.school}'`}></p>

                      <AvInput label="Location" name="location" x-model="formData.location" maxlength={RESUME_MAX.location} @input={`enforceLimit('location', ${RESUME_MAX.location})`} />

                      <div class="av-resume-field-grid-date">
                        <AvSelect label="Start year" name="start-year" x-model="formData.startYear">
                          <option value="">Select year</option>
                          {yearOptions.map((year) => <option value={year}>{year}</option>)}
                        </AvSelect>
                        <AvSelect label="Start month" name="start-month" x-model="formData.startMonth">
                          <option value="">Select month</option>
                          {monthOptions.map((month) => <option value={month.value}>{month.label}</option>)}
                        </AvSelect>
                        <AvSelect label="End year" name="end-year" x-model="formData.endYear">
                          <option value="">Select year</option>
                          {yearOptions.map((year) => <option value={year}>{year}</option>)}
                        </AvSelect>
                        <AvSelect label="End month" name="end-month" x-model="formData.endMonth">
                          <option value="">Select month</option>
                          {monthOptions.map((month) => <option value={month.value}>{month.label}</option>)}
                        </AvSelect>
                      </div>

                      <AvInput label="Grade" name="grade" x-model="formData.grade" maxlength={RESUME_MAX.grade} @input={`enforceLimit('grade', ${RESUME_MAX.grade})`} />
                      <AvTextarea label="Notes (one per line)" name="bullets" rows={4} x-model="formData.bullets" maxlength={RESUME_MAX.bulletBlock} @input={`enforceLineLimit('bullets', ${RESUME_MAX.bulletLine})`} />
                      <p class="av-form-hint">Each note max {RESUME_MAX.bulletLine} characters.</p>
                    </form>
                  </div>
                </template>

                <template x-if="activeSectionKey === 'skills'">
                  <div class="av-auth-stack-md">
                    <template x-if="activeSectionItems.length">
                      <div class="av-auth-stack-xs">
                        <template x-for="item in activeSectionItems" :key="item.id">
                          <div class="av-resume-item-row">
                            <p class="av-text-strong" x-text="itemLabel(item)"></p>
                            <div class="rb-experience-actions">
                              <AvButton
                                variant="ghost"
                                size="sm"
                                type="button"
                                className="rb-experience-action-btn"
                                aria-label="Edit skill"
                                title="Edit skill"
                                @click.prevent="editItem(item)"
                              >
                                <AvIcon name="edit" size="sm" />
                              </AvButton>
                              <AvButton
                                variant="ghost"
                                size="sm"
                                type="button"
                                className="rb-experience-action-btn"
                                aria-label="Delete skill"
                                title="Delete skill"
                                @click.prevent="deleteItem(item.id)"
                              >
                                <AvIcon name="trash" size="sm" />
                              </AvButton>
                            </div>
                          </div>
                        </template>
                      </div>
                    </template>
                    <AvButton variant="ghost" size="sm" type="button" className="rb-experience-add-btn" @click.prevent="startNewItem()">
                      <AvIcon name="plus" size="sm" />
                      <span>Add skill</span>
                    </AvButton>

                    <form class="av-auth-stack-sm" @submit.prevent="saveActiveItem()">
                      <AvInput label="Skill" name="skill-name" x-model="formData.name" maxlength={RESUME_MAX.skill} @input={`enforceLimit('name', ${RESUME_MAX.skill})`} required />
                      <p class="av-form-hint" x-text={`(formData.name || '').length + ' / ${RESUME_MAX.skill}'`}></p>

                      <AvSelect label="Level" name="skill-level" x-model="formData.level">
                        <option value="">Select level</option>
                        <option value="Beginner">Beginner</option>
                        <option value="Intermediate">Intermediate</option>
                        <option value="Advanced">Advanced</option>
                        <option value="Expert">Expert</option>
                      </AvSelect>
                    </form>
                  </div>
                </template>

                <template x-if="activeSectionKey === 'projects'">
                  <div class="av-auth-stack-md">
                    <template x-if="activeSectionItems.length">
                      <div class="av-auth-stack-xs">
                        <template x-for="item in activeSectionItems" :key="item.id">
                          <div class="av-resume-item-row">
                            <p class="av-text-strong" x-text="itemLabel(item)"></p>
                            <div class="rb-experience-actions">
                              <AvButton
                                variant="ghost"
                                size="sm"
                                type="button"
                                className="rb-experience-action-btn"
                                aria-label="Edit project"
                                title="Edit project"
                                @click.prevent="editItem(item)"
                              >
                                <AvIcon name="edit" size="sm" />
                              </AvButton>
                              <AvButton
                                variant="ghost"
                                size="sm"
                                type="button"
                                className="rb-experience-action-btn"
                                aria-label="Delete project"
                                title="Delete project"
                                @click.prevent="deleteItem(item.id)"
                              >
                                <AvIcon name="trash" size="sm" />
                              </AvButton>
                            </div>
                          </div>
                        </template>
                      </div>
                    </template>
                    <AvButton variant="ghost" size="sm" type="button" className="rb-experience-add-btn" @click.prevent="startNewItem()">
                      <AvIcon name="plus" size="sm" />
                      <span>Add project</span>
                    </AvButton>

                    <form class="av-auth-stack-sm" @submit.prevent="saveActiveItem()">
                      <AvInput label="Project name" name="project-name" x-model="formData.name" maxlength={RESUME_MAX.projectName} @input={`enforceLimit('name', ${RESUME_MAX.projectName})`} required />
                      <p class="av-form-hint" x-text={`(formData.name || '').length + ' / ${RESUME_MAX.projectName}'`}></p>

                      <AvInput label="Project link" type="url" name="project-link" x-model="formData.link" maxlength={RESUME_MAX.projectLink} @input={`enforceLimit('link', ${RESUME_MAX.projectLink})`} />

                      <div class="av-resume-field-grid-date">
                        <AvSelect label="Start year" name="start-year" x-model="formData.startYear">
                          <option value="">Select year</option>
                          {yearOptions.map((year) => <option value={year}>{year}</option>)}
                        </AvSelect>
                        <AvSelect label="Start month" name="start-month" x-model="formData.startMonth">
                          <option value="">Select month</option>
                          {monthOptions.map((month) => <option value={month.value}>{month.label}</option>)}
                        </AvSelect>
                        <AvSelect label="End year" name="end-year" x-model="formData.endYear" :disabled="formData.present">
                          <option value="">Select year</option>
                          {yearOptions.map((year) => <option value={year}>{year}</option>)}
                        </AvSelect>
                        <AvSelect label="End month" name="end-month" x-model="formData.endMonth" :disabled="formData.present">
                          <option value="">Select month</option>
                          {monthOptions.map((month) => <option value={month.value}>{month.label}</option>)}
                        </AvSelect>
                      </div>

                      <label class="av-inline-check av-text-soft">
                        <input class="av-checkbox" type="checkbox" x-model="formData.present" @change="togglePresent()" />
                        <span>Ongoing</span>
                      </label>

                      <AvTextarea label="Summary" name="summary" rows={3} x-model="formData.summary" maxlength={RESUME_MAX.projectSummary} @input={`enforceLimit('summary', ${RESUME_MAX.projectSummary})`} />
                      <p class="av-form-hint" x-text={`(formData.summary || '').length + ' / ${RESUME_MAX.projectSummary}'`}></p>

                      <AvTextarea label="Highlights (one per line)" name="bullets" rows={4} x-model="formData.bullets" maxlength={RESUME_MAX.bulletBlock} @input={`enforceLineLimit('bullets', ${RESUME_MAX.bulletLine})`} />
                      <p class="av-form-hint">Each bullet max {RESUME_MAX.bulletLine} characters.</p>

                      <AvInput label="Tags (comma separated)" name="tags" x-model="formData.tags" maxlength={RESUME_MAX.tagsLine} @input={`enforceLimit('tags', ${RESUME_MAX.tagsLine})`} />
                    </form>
                  </div>
                </template>

                <template x-if="activeSectionKey === 'certifications'">
                  <div class="av-auth-stack-md">
                    <template x-if="activeSectionItems.length">
                      <div class="av-auth-stack-xs">
                        <template x-for="item in activeSectionItems" :key="item.id">
                          <div class="av-resume-item-row">
                            <p class="av-text-strong" x-text="itemLabel(item)"></p>
                            <div class="rb-experience-actions">
                              <AvButton
                                variant="ghost"
                                size="sm"
                                type="button"
                                className="rb-experience-action-btn"
                                aria-label="Edit certification"
                                title="Edit certification"
                                @click.prevent="editItem(item)"
                              >
                                <AvIcon name="edit" size="sm" />
                              </AvButton>
                              <AvButton
                                variant="ghost"
                                size="sm"
                                type="button"
                                className="rb-experience-action-btn"
                                aria-label="Delete certification"
                                title="Delete certification"
                                @click.prevent="deleteItem(item.id)"
                              >
                                <AvIcon name="trash" size="sm" />
                              </AvButton>
                            </div>
                          </div>
                        </template>
                      </div>
                    </template>
                    <AvButton variant="ghost" size="sm" type="button" className="rb-experience-add-btn" @click.prevent="startNewItem()">
                      <AvIcon name="plus" size="sm" />
                      <span>Add certification</span>
                    </AvButton>

                    <form class="av-auth-stack-sm" @submit.prevent="saveActiveItem()">
                      <AvInput label="Certification" name="cert-name" x-model="formData.name" maxlength={RESUME_MAX.certificationName} @input={`enforceLimit('name', ${RESUME_MAX.certificationName})`} required />
                      <p class="av-form-hint" x-text={`(formData.name || '').length + ' / ${RESUME_MAX.certificationName}'`}></p>

                      <AvInput label="Issuer" name="cert-issuer" x-model="formData.issuer" maxlength={RESUME_MAX.issuer} @input={`enforceLimit('issuer', ${RESUME_MAX.issuer})`} />
                      <AvSelect label="Year" name="cert-year" x-model="formData.year">
                        <option value="">Select year</option>
                        {yearOptions.map((year) => <option value={year}>{year}</option>)}
                      </AvSelect>
                      <AvInput label="Link" type="url" name="cert-link" x-model="formData.link" maxlength={RESUME_MAX.projectLink} @input={`enforceLimit('link', ${RESUME_MAX.projectLink})`} />
                    </form>
                  </div>
                </template>

                <template x-if="activeSectionKey === 'awards'">
                  <div class="av-auth-stack-md">
                    <template x-if="activeSectionItems.length">
                      <div class="av-auth-stack-xs">
                        <template x-for="item in activeSectionItems" :key="item.id">
                          <div class="av-resume-item-row">
                            <p class="av-text-strong" x-text="itemLabel(item)"></p>
                            <div class="rb-experience-actions">
                              <AvButton
                                variant="ghost"
                                size="sm"
                                type="button"
                                className="rb-experience-action-btn"
                                aria-label="Edit achievement"
                                title="Edit achievement"
                                @click.prevent="editItem(item)"
                              >
                                <AvIcon name="edit" size="sm" />
                              </AvButton>
                              <AvButton
                                variant="ghost"
                                size="sm"
                                type="button"
                                className="rb-experience-action-btn"
                                aria-label="Delete achievement"
                                title="Delete achievement"
                                @click.prevent="deleteItem(item.id)"
                              >
                                <AvIcon name="trash" size="sm" />
                              </AvButton>
                            </div>
                          </div>
                        </template>
                      </div>
                    </template>
                    <AvButton variant="ghost" size="sm" type="button" className="rb-experience-add-btn" @click.prevent="startNewItem()">
                      <AvIcon name="plus" size="sm" />
                      <span>Add achievement</span>
                    </AvButton>

                    <form class="av-auth-stack-sm" @submit.prevent="saveActiveItem()">
                      <AvInput label="Title" name="award-title" x-model="formData.title" maxlength={RESUME_MAX.awardTitle} required />
                      <p class="av-form-hint" x-text={`(formData.title || '').length + ' / ${RESUME_MAX.awardTitle}'`}></p>

                      <AvSelect label="Year" name="award-year" x-model="formData.year">
                        <option value="">Select year</option>
                        {yearOptions.map((year) => <option value={year}>{year}</option>)}
                      </AvSelect>
                      <AvInput label="By" name="award-by" x-model="formData.by" maxlength={RESUME_MAX.awardBy} />
                      <AvTextarea label="Summary" name="award-summary" rows={3} x-model="formData.summary" maxlength={RESUME_MAX.awardSummary} />
                      <p class="av-form-hint" x-text={`(formData.summary || '').length + ' / ${RESUME_MAX.awardSummary}'`}></p>
                    </form>
                  </div>
                </template>

                <template x-if="activeSectionKey === 'languages'">
                  <div class="av-auth-stack-md">
                    <template x-if="activeSectionItems.length">
                      <div class="av-auth-stack-xs">
                        <template x-for="item in activeSectionItems" :key="item.id">
                          <div class="av-resume-item-row">
                            <p class="av-text-strong" x-text="itemLabel(item)"></p>
                            <div class="rb-experience-actions">
                              <AvButton
                                variant="ghost"
                                size="sm"
                                type="button"
                                className="rb-experience-action-btn"
                                aria-label="Edit language"
                                title="Edit language"
                                @click.prevent="editItem(item)"
                              >
                                <AvIcon name="edit" size="sm" />
                              </AvButton>
                              <AvButton
                                variant="ghost"
                                size="sm"
                                type="button"
                                className="rb-experience-action-btn"
                                aria-label="Delete language"
                                title="Delete language"
                                @click.prevent="deleteItem(item.id)"
                              >
                                <AvIcon name="trash" size="sm" />
                              </AvButton>
                            </div>
                          </div>
                        </template>
                      </div>
                    </template>
                    <AvButton variant="ghost" size="sm" type="button" className="rb-experience-add-btn" @click.prevent="startNewItem()">
                      <AvIcon name="plus" size="sm" />
                      <span>Add language</span>
                    </AvButton>

                    <form class="av-auth-stack-sm" @submit.prevent="saveActiveItem()">
                      <AvInput label="Language" name="language-name" x-model="formData.name" maxlength={RESUME_MAX.language} required />
                      <p class="av-form-hint" x-text={`(formData.name || '').length + ' / ${RESUME_MAX.language}'`}></p>

                      <AvSelect label="Proficiency" name="language-level" x-model="formData.proficiency">
                        <option value="">Select proficiency</option>
                        <option value="Native">Native</option>
                        <option value="Fluent">Fluent</option>
                        <option value="Professional">Professional</option>
                        <option value="Intermediate">Intermediate</option>
                        <option value="Basic">Basic</option>
                      </AvSelect>
                    </form>
                  </div>
                </template>

                <template x-if="activeSectionKey === 'highlights'">
                  <div class="av-auth-stack-md">
                    <template x-if="activeSectionItems.length">
                      <div class="av-auth-stack-xs">
                        <template x-for="item in activeSectionItems" :key="item.id">
                          <div class="av-resume-item-row">
                            <p class="av-text-strong" x-text="itemLabel(item)"></p>
                            <div class="rb-experience-actions">
                              <AvButton
                                variant="ghost"
                                size="sm"
                                type="button"
                                className="rb-experience-action-btn"
                                aria-label="Edit highlight"
                                title="Edit highlight"
                                @click.prevent="editItem(item)"
                              >
                                <AvIcon name="edit" size="sm" />
                              </AvButton>
                              <AvButton
                                variant="ghost"
                                size="sm"
                                type="button"
                                className="rb-experience-action-btn"
                                aria-label="Delete highlight"
                                title="Delete highlight"
                                @click.prevent="deleteItem(item.id)"
                              >
                                <AvIcon name="trash" size="sm" />
                              </AvButton>
                            </div>
                          </div>
                        </template>
                      </div>
                    </template>
                    <AvButton variant="ghost" size="sm" type="button" className="rb-experience-add-btn" @click.prevent="startNewItem()">
                      <AvIcon name="plus" size="sm" />
                      <span>Add highlight</span>
                    </AvButton>

                    <form class="av-auth-stack-sm" @submit.prevent="saveActiveItem()">
                      <AvTextarea label="Highlight" name="highlight" rows={3} x-model="formData.text" maxlength={RESUME_MAX.highlight} />
                      <p class="av-form-hint" x-text={`(formData.text || '').length + ' / ${RESUME_MAX.highlight}'`}></p>
                    </form>
                  </div>
                </template>
                </div>

                <div slot="footer" class="av-auth-stack-xs">
                  <template x-if="drawerError">
                    <div class="av-alert av-alert-danger" role="status" x-text="drawerError"></div>
                  </template>
                  <template x-if="drawerWarning">
                    <div class="av-alert av-alert-warning" role="status" x-text="drawerWarning"></div>
                  </template>
                  <div class="av-row-wrap">
                    <AvButton variant="ghost" type="button" @click="closeDrawer()" x-text="activeSectionKey === 'photo' ? 'Done' : 'Close'"></AvButton>
                    <AvButton type="button" @click="saveActiveItem()" :disabled="loading" x-show="activeSectionKey !== 'photo'">
                      <span x-show="!loading">Save</span>
                      <span x-show="loading">Saving…</span>
                    </AvButton>
                  </div>
                </div>
              </ResumeEditorDrawer>
            </div>
          </div>
        </template>
      </div>
    </AvContainer>
  </section>
</AppShell>

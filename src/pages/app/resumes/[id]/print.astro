---
import "@ansiversa/components/styles/global.css";
import { AvButton, AvContainer, ResumeBuilderShell } from "@ansiversa/components";
import { actions } from "astro:actions";
import { buildResumeDataFromSections } from "../../../../modules/resume-builder/helpers";
import type { ResumeProjectDetail } from "../../../../modules/resume-builder/types";

const projectId = Astro.params.id ?? "";

let projectData: ResumeProjectDetail | null = null;
let loadError: string | null = null;
let isPaywall = false;

try {
  const result = await Astro.callAction(actions.resumeBuilder.getResumeProject, {
    projectId,
  });
  const data = (result as any)?.data ?? (result as any) ?? null;
  projectData = data as ResumeProjectDetail;
} catch (err) {
  loadError = (err as Error)?.message ?? "Unable to load resume.";
  isPaywall = loadError.toLowerCase().includes("upgrade to pro");
}

const resumeData = projectData ? buildResumeDataFromSections(projectData.sections ?? []) : null;
const templateKey = projectData?.project?.templateKey ?? "classic";
const pageTitle = projectData?.project?.title
  ? `${projectData.project.title} â€“ Print`
  : "Resume Print";
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{pageTitle}</title>
  </head>
  <body class="rb-print">
    <AvContainer size="full" className="rb-print__toolbar-container">
      <div class="rb-print__toolbar rb-print__toolbar-surface">
        <div>
          <p class="av-kicker">Resume Builder</p>
          <h1 class="av-section-title">Print / Preview</h1>
          <p class="av-text-soft">Use browser print to download as PDF.</p>
        </div>
        <div class="rb-print__actions">
          <AvButton href={`/app/resumes/${projectId}`} variant="ghost">Back to editor</AvButton>
          <AvButton type="button" onclick="window.print()">Print / Download PDF</AvButton>
        </div>
      </div>
    </AvContainer>

    <main class="rb-print__page">
      {loadError ? (
        <AvContainer>
          <div class="av-alert av-alert-danger" role="status">{loadError}</div>
          {isPaywall ? (
            <div style="margin-top: 1rem;">
              <AvButton href="https://ansiversa.com/pricing" variant="primary">
                View pricing
              </AvButton>
            </div>
          ) : null}
        </AvContainer>
      ) : resumeData ? (
        <AvContainer size="full" className="rb-print__content">
          <ResumeBuilderShell type={templateKey} data={resumeData} />
        </AvContainer>
      ) : null}
    </main>

    <style>
      .rb-print {
        background: #fff;
        color: #0f172a;
        min-height: 100vh;
        color-scheme: light;
        --av-bg: #ffffff;
        --av-surface: #ffffff;
        --av-surface-soft: #f8fafc;
        --av-border-subtle: rgba(15, 23, 42, 0.12);
        --av-border-strong: rgba(15, 23, 42, 0.25);
        --av-text: #0f172a;
        --av-text-muted: #475569;
        --av-text-soft: #64748b;
        --av-text-strong: #0b1220;
      }

      .rb-print__toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1.5rem;
        padding: 2rem 0 1rem;
      }

      .rb-print__toolbar-container {
        padding: 0;
      }

      .rb-print__toolbar-surface {
        background: radial-gradient(circle at top left, rgba(0, 234, 255, 0.18), transparent 55%),
          radial-gradient(circle at bottom right, rgba(122, 0, 255, 0.2), transparent 60%),
          #0b1120;
        border-radius: 0;
        margin-top: 0;
        padding: 2rem;
        box-shadow: 0 14px 32px rgba(2, 6, 23, 0.35);
      }

      .rb-print__actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      .rb-print__page {
        background: #fff;
        padding: 1rem 0 3rem;
      }

      .rb-print__content {
        padding: 0 0.5rem;
      }

      .rb-print__page .resume-template > main {
        max-width: 80rem;
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }

      @media print {
        .rb-print__toolbar {
          display: none;
        }

        .rb-print__page {
          padding: 0;
        }

        .rb-print__content {
          padding: 0;
        }
      }
    </style>
  </body>
</html>

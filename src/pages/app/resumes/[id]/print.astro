---
import "@ansiversa/components/styles/global.css";
import "../../../../styles/global.css";
import { AvButton, AvContainer, ResumeBuilderShell } from "@ansiversa/components";
import { actions } from "astro:actions";
import { buildResumeDataFromSections, sanitizePrintText } from "../../../../modules/resume-builder/helpers";
import ResumeTemplateModernTwoToneLocal from "../../../../modules/resume-builder/ResumeTemplateModernTwoToneLocal.astro";
import type { ResumeProjectDetail } from "../../../../modules/resume-builder/types";

const projectId = Astro.params.id ?? "";
const isPreview = Astro.url.searchParams.get("preview") === "1";

let projectData: ResumeProjectDetail | null = null;
let loadError: string | null = null;
let isPaywall = false;

try {
  const result = await Astro.callAction(actions.resumeBuilder.getResumeProject, {
    projectId,
  });
  const data = (result as any)?.data ?? (result as any) ?? null;
  projectData = data as ResumeProjectDetail;
} catch (err) {
  loadError = (err as Error)?.message ?? "Unable to load resume.";
  isPaywall = loadError.toLowerCase().includes("upgrade to pro");
}

const resumeData = projectData ? buildResumeDataFromSections(projectData.sections ?? []) : null;
const projectPhotoUrl = (projectData?.project?.photoUrl ?? "").trim();

const sanitizeForPrint = <T,>(value: T): T => {
  if (typeof value === "string") return sanitizePrintText(value) as T;
  if (Array.isArray(value)) return value.map((item) => sanitizeForPrint(item)) as T;
  if (value && typeof value === "object") {
    const entries = Object.entries(value as Record<string, unknown>).map(([key, item]) => [
      key,
      sanitizeForPrint(item),
    ]);
    return Object.fromEntries(entries) as T;
  }
  return value;
};
const sanitizedResumeData = resumeData ? sanitizeForPrint(resumeData) : null;
const basics = sanitizedResumeData?.basics;
const summaryText = (basics?.summary ?? "").trim();
const toFilenamePart = (value?: string | null) =>
  sanitizePrintText(value)
    .replace(/[^A-Za-z0-9\s-]/g, " ")
    .trim()
    .replace(/\s+/g, "-")
    .replace(/-+/g, "-")
    .replace(/^-+|-+$/g, "");
const nameParts = sanitizePrintText(basics?.fullName ?? "")
  .replace(/\s+/g, " ")
  .trim()
  .split(" ")
  .filter(Boolean);
const firstName = toFilenamePart(nameParts[0] ?? "");
const lastName = toFilenamePart(nameParts.length > 1 ? nameParts[nameParts.length - 1] : "");
const jobTitle = toFilenamePart(basics?.headline ?? "");
const fallbackTitle = toFilenamePart(projectData?.project?.title ?? "");
const pageTitle = [firstName, lastName, jobTitle].filter(Boolean).join("-") || fallbackTitle || "Resume";
const resumeShellData = sanitizedResumeData
  ? {
      ...sanitizedResumeData,
      basics: {
        ...sanitizedResumeData.basics,
        fullName: "",
        headline: "",
        summary: "",
        location: { label: "", city: "", country: "" },
        contact: { email: "", phone: "", website: "" },
        links: [],
      },
    }
  : null;
const contactEntries: Array<{ key: string; value: string; href?: string }> = [];
const MAX_CONTACT_URL_DISPLAY_LENGTH = 40;
const normalizeHref = (value: string) => {
  const trimmed = value.trim();
  if (!trimmed) return "";
  return /^https?:\/\//i.test(trimmed) ? trimmed : `https://${trimmed}`;
};
const formatDisplayUrl = (value: string) => {
  const href = normalizeHref(value);
  if (!href) return "";
  try {
    const parsed = new URL(href);
    const hostname = parsed.hostname.replace(/^www\./i, "");
    if (!hostname) return "";
    const path = parsed.pathname && parsed.pathname !== "/" ? parsed.pathname.replace(/\/+$/, "") : "";
    const cleaned = `${hostname}${path}`;
    if (cleaned.length <= MAX_CONTACT_URL_DISPLAY_LENGTH) {
      return cleaned;
    }
    return `${hostname}/...`;
  } catch {
    return value
      .replace(/^https?:\/\//i, "")
      .replace(/^www\./i, "")
      .replace(/\/+$/, "");
  }
};
const normalizeGithubUrl = (value: string) => {
  const trimmed = value.trim();
  if (!trimmed) return "";
  const withoutProtocol = trimmed.replace(/^https?:\/\//i, "").replace(/^www\./i, "");
  if (/^github\.com\//i.test(withoutProtocol)) return `https://${withoutProtocol}`;
  if (/^github\.com[^/]/i.test(withoutProtocol)) {
    const username = withoutProtocol.replace(/^github\.com/i, "").replace(/^\/+/, "");
    return username ? `https://github.com/${username}` : "";
  }
  if (/^[a-zA-Z0-9-]+$/.test(withoutProtocol)) {
    return `https://github.com/${withoutProtocol}`;
  }
  return /^https?:\/\//i.test(trimmed) ? trimmed : `https://${trimmed}`;
};
const normalizeLocationLabel = (value: string) =>
  value
    .replace(/\bAbudhabi\b/gi, "Abu Dhabi")
    .replace(/\s{2,}/g, " ")
    .trim();
const seenContactHrefs = new Set<string>();
const pushContactEntry = (entryKey: string, value: string, href?: string) => {
  const normalizedKey = entryKey.trim();
  const normalizedValue = value.trim();
  if (!normalizedKey || !normalizedValue) return;
  const dedupeKey = `${normalizedKey.toLowerCase()}|${(href ?? normalizedValue).toLowerCase()}`;
  if (seenContactHrefs.has(dedupeKey)) return;
  seenContactHrefs.add(dedupeKey);
  contactEntries.push({ key: normalizedKey, value: normalizedValue, href });
};

const locationLabel =
  normalizeLocationLabel(
    basics?.location?.label ||
      [basics?.location?.city, basics?.location?.country].filter(Boolean).join(", "),
  );
if (basics?.contact?.email) {
  pushContactEntry("Email", basics.contact.email, `mailto:${basics.contact.email}`);
}
if (basics?.contact?.website) {
  const href = normalizeHref(basics.contact.website);
  pushContactEntry("Website", formatDisplayUrl(href), href);
}
for (const link of basics?.links ?? []) {
  const label = (link?.label ?? "").trim();
  const url = (link?.url ?? "").trim();
  if (!label || !url) continue;
  if (label.toLowerCase() === "website") continue;
  const href = label.toLowerCase() === "github"
    ? normalizeGithubUrl(url)
    : normalizeHref(url);
  const displayValue = formatDisplayUrl(href || url);
  pushContactEntry(label, displayValue, href);
}
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{pageTitle}</title>
  </head>
  <body class={`av-resume-print-body ${isPreview ? "av-resume-preview resume-preview" : "av-resume-print resume-print"}`}>
    <div class="av-resume-print-header print:hidden">
      <AvContainer>
        <div class="av-resume-print-header-inner">
          <div class="av-auth-stack-xxs">
            <p class="av-kicker">Resume Builder</p>
            <h1 class="av-section-title av-resume-print-heading">Print / Preview</h1>
            <p class="av-text-soft">Use browser print to download as PDF.</p>
            <div class="rb-print-hint" role="note" aria-label="Print tip">
              <p class="rb-print-hint-title">Print tip</p>
              <p class="rb-print-hint-body">
                For a clean PDF, open “More settings” and disable “Headers and footers”.
              </p>
              <p class="rb-print-hint-body">
                This removes the extra date, URL, and page title added by the browser.
              </p>
            </div>
          </div>
          <div class="av-row-wrap">
            <AvButton type="button" onclick="window.print()">Print / Download PDF</AvButton>
          </div>
        </div>
      </AvContainer>
    </div>

    <main class="av-resume-print-main print:py-0">
      {loadError ? (
        <AvContainer>
          <div class="av-alert av-alert-danger" role="status">{loadError}</div>
          {isPaywall ? (
            <div class="av-resume-print-paywall-cta">
              <AvButton href="https://ansiversa.com/pricing" variant="primary">
                View pricing
              </AvButton>
            </div>
          ) : null}
        </AvContainer>
      ) : resumeData ? (
        <AvContainer>
          <article class="av-resume-standard">
            <header class="av-resume-standard-header">
              {projectPhotoUrl ? (
                <div class="av-resume-standard-photo-wrap">
                  <img
                    class="av-resume-standard-photo"
                    src={projectPhotoUrl}
                    alt="Resume profile photo"
                    loading="lazy"
                  />
                </div>
              ) : null}

              <div class="av-resume-standard-identity">
                <h1 class="av-resume-standard-name">{basics?.fullName || "Your Name"}</h1>
                <p class="av-resume-standard-headline">{basics?.headline || "Professional Title"}</p>
                {locationLabel ? <p class="av-resume-standard-location">{locationLabel}</p> : null}
                {basics?.contact?.phone ? <p class="av-resume-standard-phone">{basics.contact.phone}</p> : null}
              </div>

              <div class="av-resume-standard-contacts">
                {contactEntries.map((entry) =>
                  <div class="av-resume-contact-row">
                    <span class="av-resume-contact-key">{entry.key}</span>
                    <span class="av-resume-contact-colon">:</span>
                    {entry.href ? (
                      <a class="av-resume-contact-value" href={entry.href}>{entry.value}</a>
                    ) : (
                      <span class="av-resume-contact-value">{entry.value}</span>
                    )}
                  </div>,
                )}
              </div>
            </header>

            {summaryText ? (
              <section class="av-resume-standard-summary">
                <h2>SUMMARY</h2>
                <p>{summaryText}</p>
              </section>
            ) : null}
          </article>

          {resumeShellData ? (
            <div class="av-resume-template-underlay">
              {(projectData?.project?.templateKey ?? "classic") === "modern" ? (
                <ResumeTemplateModernTwoToneLocal data={resumeShellData} />
              ) : (
                <ResumeBuilderShell type={projectData?.project?.templateKey ?? "classic"} data={resumeShellData} />
              )}
            </div>
          ) : null}
        </AvContainer>
      ) : null}
    </main>
    <script is:inline define:vars={{ pageTitle }}>
      document.title = pageTitle;
    </script>
  </body>
</html>
